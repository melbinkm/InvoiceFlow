{% extends "base.html" %}

{% block title %}Edit Invoice {{ invoice.invoice_number }} - InvoiceFlow{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-pencil"></i> Edit Invoice {{ invoice.invoice_number }}</h2>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('invoice.view_invoice', id=invoice.id) }}"
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Invoice
            </a>
        </div>
    </div>

    <!-- Vulnerability #4: IDOR - can edit any invoice by changing invoice_id -->
    <!-- Vulnerability #7: No CSRF protection -->
    <!-- Vulnerability #28: Client-side only validation -->
    <form method="POST" action="{{ url_for('invoice.edit_invoice', invoice_id=invoice.id) }}">
        <div class="card shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="company_id" class="form-label">Client *</label>
                        <select class="form-select" id="company_id" name="company_id" required>
                            <option value="">Select a client...</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}"
                                    {% if company.id == invoice.company_id %}selected{% endif %}>
                                {{ company.company_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="invoice_date" class="form-label">Invoice Date *</label>
                        <input type="date" class="form-control" id="invoice_date" name="invoice_date"
                               value="{{ invoice.invoice_date }}" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="due_date" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="due_date" name="due_date"
                               value="{{ invoice.due_date or '' }}">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="status" class="form-label">Status *</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="draft" {% if invoice.status == 'draft' %}selected{% endif %}>Draft</option>
                            <option value="sent" {% if invoice.status == 'sent' %}selected{% endif %}>Sent</option>
                            <option value="paid" {% if invoice.status == 'paid' %}selected{% endif %}>Paid</option>
                            <option value="overdue" {% if invoice.status == 'overdue' %}selected{% endif %}>Overdue</option>
                        </select>
                    </div>
                </div>

                <!-- Line Items -->
                <h5 class="mt-4 mb-3">Line Items</h5>
                <div id="items-container">
                    {% for item in items %}
                    <div class="row mb-3 item-row">
                        <div class="col-md-5">
                            <label class="form-label">Description *</label>
                            <input type="text" class="form-control" name="description[]"
                                   value="{{ item.description }}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control quantity" name="quantity[]"
                                   step="0.01" value="{{ item.quantity }}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Unit Price *</label>
                            <input type="number" class="form-control unit-price" name="unit_price[]"
                                   step="0.01" value="{{ item.unit_price }}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Amount</label>
                            <input type="text" class="form-control amount"
                                   value="{{ '%.2f'|format(item.amount) }}" readonly>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger w-100 remove-item">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary mb-4" id="add-item">
                    <i class="bi bi-plus"></i> Add Line Item
                </button>

                <!-- Totals -->
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="mb-3">
                            <label for="tax_rate" class="form-label">Tax Rate (%)</label>
                            <input type="number" class="form-control" id="tax_rate" name="tax_rate"
                                   step="0.01" value="{{ invoice.tax_rate }}">
                        </div>
                        <div class="mb-3">
                            <label for="discount" class="form-label">Discount ($)</label>
                            <input type="number" class="form-control" id="discount" name="discount"
                                   step="0.01" value="{{ invoice.discount }}">
                        </div>
                    </div>
                </div>

                <!-- Notes and Terms -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">{{ invoice.notes }}</textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="terms" class="form-label">Terms & Conditions</label>
                        <textarea class="form-control" id="terms" name="terms" rows="3">{{ invoice.terms }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-circle"></i> Save Changes
            </button>
            <a href="{{ url_for('invoice.view_invoice', id=invoice.id) }}"
               class="btn btn-outline-secondary btn-lg">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Vulnerability #28: Client-side only validation -->
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Same JS as create.html for calculating amounts
document.addEventListener('DOMContentLoaded', function() {
    function calculateAmount(row) {
        const qty = parseFloat(row.querySelector('.quantity').value) || 0;
        const price = parseFloat(row.querySelector('.unit-price').value) || 0;
        const amount = qty * price;
        row.querySelector('.amount').value = amount.toFixed(2);
    }

    document.getElementById('items-container').addEventListener('input', function(e) {
        if (e.target.classList.contains('quantity') || e.target.classList.contains('unit-price')) {
            calculateAmount(e.target.closest('.item-row'));
        }
    });

    document.getElementById('add-item').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const newRow = container.querySelector('.item-row').cloneNode(true);
        newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
            if (!input.classList.contains('amount')) {
                input.value = input.name.includes('quantity') ? '1' : '0';
            }
        });
        container.appendChild(newRow);
    });

    document.getElementById('items-container').addEventListener('click', function(e) {
        if (e.target.closest('.remove-item')) {
            const rows = document.querySelectorAll('.item-row');
            if (rows.length > 1) {
                e.target.closest('.item-row').remove();
            }
        }
    });
});
</script>
{% endblock %}
