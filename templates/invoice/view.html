{% extends "base.html" %}

{% block title %}Invoice {{ invoice.invoice_number }} - InvoiceFlow{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-file-earmark-text"></i> Invoice {{ invoice.invoice_number }}</h2>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <a href="{{ url_for('invoice.edit_invoice', invoice_id=invoice.id) }}"
                   class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <!-- Vulnerability #5: Command injection via filename parameter -->
                <a href="{{ url_for('invoice.generate_pdf', invoice_id=invoice.id) }}"
                   class="btn btn-outline-success">
                    <i class="bi bi-file-pdf"></i> Download PDF
                </a>
                <a href="{{ url_for('invoice.list_invoices') }}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body p-5">
            <!-- Invoice Header -->
            <div class="row mb-5">
                <div class="col-md-6">
                    <h1 class="text-primary mb-3">
                        <i class="bi bi-receipt"></i> INVOICE
                    </h1>
                    <p class="mb-1"><strong>Invoice Number:</strong> {{ invoice.invoice_number }}</p>
                    <p class="mb-1"><strong>Date:</strong> {{ invoice.invoice_date }}</p>
                    {% if invoice.due_date %}
                    <p class="mb-1"><strong>Due Date:</strong> {{ invoice.due_date }}</p>
                    {% endif %}
                    <p class="mb-1">
                        <strong>Status:</strong>
                        {% if invoice.status == 'paid' %}
                            <span class="badge bg-success">Paid</span>
                        {% elif invoice.status == 'sent' %}
                            <span class="badge bg-warning">Sent</span>
                        {% elif invoice.status == 'overdue' %}
                            <span class="badge bg-danger">Overdue</span>
                        {% else %}
                            <span class="badge bg-secondary">Draft</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    {% if company %}
                    <h5 class="mb-3">Bill To:</h5>
                    <p class="mb-1"><strong>{{ company.company_name }}</strong></p>
                    {% if company.contact_person %}
                    <p class="mb-1">{{ company.contact_person }}</p>
                    {% endif %}
                    {% if company.email %}
                    <p class="mb-1">{{ company.email }}</p>
                    {% endif %}
                    {% if company.phone %}
                    <p class="mb-1">{{ company.phone }}</p>
                    {% endif %}
                    {% if company.address %}
                    <p class="mb-1">{{ company.address }}</p>
                    <p class="mb-1">{{ company.city }}, {{ company.state }} {{ company.zip_code }}</p>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Invoice Items -->
            <div class="table-responsive mb-4">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Description</th>
                            <th class="text-end" style="width: 100px;">Quantity</th>
                            <th class="text-end" style="width: 120px;">Unit Price</th>
                            <th class="text-end" style="width: 120px;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <!-- Vulnerability #6: Stored XSS in description -->
                            <td>{{ item.description|safe }}</td>
                            <td class="text-end">{{ item.quantity }}</td>
                            <td class="text-end">${{ "%.2f"|format(item.unit_price) }}</td>
                            <td class="text-end">${{ "%.2f"|format(item.amount) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                            <td class="text-end">${{ "%.2f"|format(invoice.subtotal) }}</td>
                        </tr>
                        {% if invoice.tax_rate > 0 %}
                        <tr>
                            <td colspan="3" class="text-end"><strong>Tax ({{ invoice.tax_rate }}%):</strong></td>
                            <td class="text-end">${{ "%.2f"|format(invoice.tax_amount) }}</td>
                        </tr>
                        {% endif %}
                        {% if invoice.discount > 0 %}
                        <tr>
                            <td colspan="3" class="text-end"><strong>Discount:</strong></td>
                            <td class="text-end">-${{ "%.2f"|format(invoice.discount) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="table-primary">
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td class="text-end"><strong>${{ "%.2f"|format(invoice.total) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Notes and Terms -->
            {% if invoice.notes %}
            <div class="mb-4">
                <h5>Notes:</h5>
                <!-- Vulnerability #6: Stored XSS in notes field -->
                <!-- Vulnerability: autoescaping disabled for XSS -->
                {% autoescape false %}
                <div class="p-3 bg-light rounded">{{ invoice.notes }}</div>
                {% endautoescape %}
            </div>
            {% endif %}

            {% if invoice.terms %}
            <div class="mb-4">
                <h5>Terms & Conditions:</h5>
                <div class="p-3 bg-light rounded small">{{ invoice.terms }}</div>
            </div>
            {% endif %}

            <!-- Attachment -->
            {% if invoice.attachment_path %}
            <div class="mb-4">
                <h5>Attachment:</h5>
                <a href="{{ url_for('invoice.download_attachment', invoice_id=invoice.id) }}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-paperclip"></i> Download Attachment
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Vulnerability #4: IDOR demonstration - try changing invoice_id in URL -->
    <!-- Example: /invoice/view/1, /invoice/view/2, etc. -->
</div>
{% endblock %}
